<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Генеральный план Екатеринбурга</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.10.1/dist/viewer.min.css">
  <link rel="preload" href="./images/plan-current.jpg" as="image">
  <link rel="preload" href="./images/optimized.png" as="image">
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.10.1/dist/viewer.min.js"></script>
</head>

<body>
  <div class="map" data-map>
  </div>

  <select class="map-select" data-controls-switcher></select>

  <div class="map-switcher">
    <button class="map-switcher__button" data-controls-toggle="current">
      Текущий генплан
    </button>

    <button class="map-switcher__button map-switcher__button_active" data-controls-toggle="new">
      Новый генплан
    </button>
  </div>

  <button class="legend-button">Легенда</button>

  <div class="zoom">
    <button class="zoom__button zoom__button_plus" data-controls-zoom-in title="Увеличить масштаб (+)">&#43;</button>
    <button class="zoom__button zoom__button_minus" data-controls-zoom-out
      title="Уменьшить масштаб (-)">&#8722;</button>
  </div>

  <script>
    const PLANS = [
      {
        title: "Старый генплан",
        map: "plan-current.jpg",
        legend: "legend-new.jpg",
        old: true
      },
      {
        title: "Фукнциональные зоны",
        map: "optimized.png",
        legend: "legend-new.jpg",
      },
      {
        title: "Общественный транспорт",
        map: "plan-public-transport.jpg",
        legend: "legend-new.jpg"
      },
      {
        title: "Транспортная инфраструктура",
        map: "plan-transport-infrastructure.jpg",
        legend: "legend-new.jpg"
      }
    ];

    const VIEWER_ZOOM_RATIO = 0.5;

    const mapContainer = document.querySelector('[data-map]')
    const zoomInButton = document.querySelector('[data-controls-zoom-in]');
    const zoomOutButton = document.querySelector('[data-controls-zoom-out]');
    const planToggleCurrent = document.querySelector('[data-controls-toggle="current"]');
    const planToggleNew = document.querySelector('[data-controls-toggle="new"]');
    const newPlanSelect = document.querySelector('[data-controls-switcher]');

    const image = new Image();
    image.src = getImagePath(PLANS.find(plan => plan.title === "Фукнциональные зоны").map);
    mapContainer.appendChild(image);

    const viewer = new Viewer(image, {
      title: false,
      navbar: false,
      backdrop: false,
      toolbar: false,
      fullscreen: false,
      button: false,
      inline: true,
      keyboard: false,
      rotatable: false,
      scalable: false,
      toggleOnDblclick: false,
      slideOnTouch: false,
      tooltip: false,
      transition: true,
      zoomRatio: VIEWER_ZOOM_RATIO,
      maxZoomRatio: 4.5,
      minZoomRatio: .15
    });

    viewer.show();



    image.addEventListener('viewed', () => {
      viewer.zoomTo(.5);
    })

    zoomInButton.addEventListener('click', () => {
      viewer.zoom(VIEWER_ZOOM_RATIO);
    });

    zoomOutButton.addEventListener('click', () => {
      viewer.zoom(-VIEWER_ZOOM_RATIO);
    });

    document.addEventListener('keyup', ({ key }) => {
      switch (key) {
        case "-":
          viewer.zoom(-VIEWER_ZOOM_RATIO);
          break;

        case "=":
          viewer.zoom(VIEWER_ZOOM_RATIO);
          break;

        case "0":
          viewer.reset();
          break;
        default: ;
      }
    });


    planToggleCurrent.addEventListener('click', () => {
      newPlanSelect.disabled = true;
      planToggleNew.classList.remove('map-switcher__button_active');
      planToggleCurrent.classList.add('map-switcher__button_active');
      setMap("Старый генплан");
    })

    planToggleNew.addEventListener('click', () => {
      newPlanSelect.disabled = false;
      planToggleCurrent.classList.remove('map-switcher__button_active');
      planToggleNew.classList.add('map-switcher__button_active');
      setMap(newPlanSelect.value);
    })

    PLANS.filter(plan => !plan.old).map(plan => {
      const option = document.createElement('option');
      option.text = plan.title;
      option.value = plan.title;
      newPlanSelect.appendChild(option)
    });

    newPlanSelect.addEventListener('change', (e) => {
      setMap(e.target.value);
    })

    function setMap(title) {
      const image = document.querySelector('.viewer-canvas img');
      const mapUrl = getImagePath(PLANS.find(plan => title === plan.title).map);
      image.style.opacity = .5;

      setTimeout(() => image.src = mapUrl, 100);

      image.onload = () => image.style.opacity = 1;
    }

    function getImagePath(image) {
      return `./images/${image}`;
    }
  </script>
</body>


</html>
